###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.3.10338/W32 for 8051         07/Apr/2018  15:44:50 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\Source\SensorSys_Coordinator.c      #
#    Command line       =  -f D:\ProgramData\Hardware\zigbee\Projects\zstack\ #
#                          Samples\SensorSys\CC2530DB\..\..\..\Tools\CC2530DB #
#                          \f8wCoord.cfg (-DCPU32MHZ -DROOT=__near_func       #
#                          -DMAC_CFG_APP_PENDING_QUEUE=TRUE                   #
#                          -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8         #
#                          -DMAC_CFG_RX_MAX=5 -DZDO_COORDINATOR -DRTR_NWK)    #
#                          -f D:\ProgramData\Hardware\zigbee\Projects\zstack\ #
#                          Samples\SensorSys\CC2530DB\..\..\..\Tools\CC2530DB #
#                          \f8wConfig.cfg (-DZIGBEEPRO -DSECURE=0             #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFF1                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=TRUE -DPOLL_RATE=1000         #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 D:\ProgramData\Hardware\zig #
#                          bee\Projects\zstack\Samples\SensorSys\Source\Senso #
#                          rSys_Coordinator.c -D HOLD_AUTO_START -D           #
#                          BUILD_ALL_DEVICES -D REFLECTOR -D NV_INIT -D COOR  #
#                          -D xNV_RESTORE -D ZTOOL_P1 -D xMT_TASK -D          #
#                          xMT_SYS_FUNC -D xMT_SAPI_FUNC -D xMT_SAPI_CB_FUNC  #
#                          -lC D:\ProgramData\Hardware\zigbee\Projects\zstack #
#                          \Samples\SensorSys\CC2530DB\CoordinatorEB\List\    #
#                          -lA D:\ProgramData\Hardware\zigbee\Projects\zstack #
#                          \Samples\SensorSys\CC2530DB\CoordinatorEB\List\    #
#                          --diag_suppress Pe001,Pa010 -o                     #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\CoordinatorEB\Obj\ -e      #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I D:\ProgramData\Hardware\zigbee\Projects\zstack\ #
#                          Samples\SensorSys\CC2530DB\ -I                     #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\Source\ -I              #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\ZMain\TI2530DB\   #
#                          -I D:\ProgramData\Hardware\zigbee\Projects\zstack\ #
#                          Samples\SensorSys\CC2530DB\..\..\..\..\..\Componen #
#                          ts\hal\include\ -I D:\ProgramData\Hardware\zigbee\ #
#                          Projects\zstack\Samples\SensorSys\CC2530DB\..\..\. #
#                          .\..\..\Components\hal\target\CC2530EB\ -I         #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          mac\include\ -I D:\ProgramData\Hardware\zigbee\Pro #
#                          jects\zstack\Samples\SensorSys\CC2530DB\..\..\..\. #
#                          .\..\Components\mac\high_level\ -I                 #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          mac\low_level\srf04\ -I D:\ProgramData\Hardware\zi #
#                          gbee\Projects\zstack\Samples\SensorSys\CC2530DB\.. #
#                          \..\..\..\..\Components\mac\low_level\srf04\single #
#                          _chip\ -I D:\ProgramData\Hardware\zigbee\Projects\ #
#                          zstack\Samples\SensorSys\CC2530DB\..\..\..\..\..\C #
#                          omponents\mt\ -I D:\ProgramData\Hardware\zigbee\Pr #
#                          ojects\zstack\Samples\SensorSys\CC2530DB\..\..\..\ #
#                          ..\..\Components\osal\include\ -I                  #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          services\saddr\ -I D:\ProgramData\Hardware\zigbee\ #
#                          Projects\zstack\Samples\SensorSys\CC2530DB\..\..\. #
#                          .\..\..\Components\services\sdata\ -I              #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\af\ -I D:\ProgramData\Hardware\zigbee\Projec #
#                          ts\zstack\Samples\SensorSys\CC2530DB\..\..\..\..\. #
#                          .\Components\stack\nwk\ -I                         #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\sapi\ -I D:\ProgramData\Hardware\zigbee\Proj #
#                          ects\zstack\Samples\SensorSys\CC2530DB\..\..\..\.. #
#                          \..\Components\stack\sec\ -I                       #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\sys\ -I D:\ProgramData\Hardware\zigbee\Proje #
#                          cts\zstack\Samples\SensorSys\CC2530DB\..\..\..\..\ #
#                          ..\Components\stack\zdo\ -I                        #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          zmac\ -I D:\ProgramData\Hardware\zigbee\Projects\z #
#                          stack\Samples\SensorSys\CC2530DB\..\..\..\..\..\Co #
#                          mponents\zmac\f8w\ -Ohz --require_prototypes       #
#    List file          =  D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\CoordinatorEB\List\SensorS #
#                          ys_Coordinator.lst                                 #
#    Object file        =  D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\CoordinatorEB\Obj\SensorSy #
#                          s_Coordinator.r51                                  #
#                                                                             #
#                                                                             #
###############################################################################

D:\ProgramData\Hardware\zigbee\Projects\zstack\Samples\SensorSys\Source\SensorSys_Coordinator.c
      1          /**************************************************************************************************
      2            Filename:       Sys.c
      3            Revised:        $Date: 2009-03-18 15:56:27 -0700 (Wed, 18 Mar 2009) $
      4            Revision:       $Revision: 19453 $
      5          
      6            Description:    Generic Application (no Profile).
      7          
      8          
      9            Copyright 2004-2009 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED AS IS?WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com. 
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41            This application isn't intended to do anything useful, it is
     42            intended to be a simple example of an application's structure.
     43          
     44            This application sends "Hello World" to another "Generic"
     45            application every 15 seconds.  The application will also
     46            receive "Hello World" packets.
     47          
     48            The "Hello World" messages are sent/received as MSG type message.
     49          
     50            This applications doesn't have a profile, so it handles everything
     51            directly - itself.
     52          
     53            Key control:
     54              SW1:
     55              SW2:  initiates end device binding
     56              SW3:
     57              SW4:  initiates a match description request
     58          *********************************************************************/
     59          
     60          /*********************************************************************
     61           * INCLUDES
     62           */
     63          #include "AF.h"
     64          #include "ZDObject.h"
     65          #include "ZDProfile.h"
     66          #include "sapi.h"
     67          
     68          #include "SensorSys_Coor.h"
     69          #include "Bluetooth.h"
     70          #include "MT_UART.h"
     71          #include "MT.h"
     72          #include "device.h"
     73          #include "DebugTrace.h"
     74          
     75          #if !defined( WIN32 )
     76            #include "OnBoard.h"
     77          #endif
     78          
     79          /* HAL */
     80          #include "hal_led.h"
     81          #include "hal_key.h"
     82          #include "hal_uart.h"
     83          
     84          #include "nwk.h"
     85          // for SendDataRequest func
     86          #include "NLMEDE.h"
     87          #include "nwk_util.h"
     88          
     89          #include "APS.h"
     90          #include "ZDApp.h"
     91          #include "OSAL.h"
     92          #include "OSAL_Tasks.h"
     93          #include "ZComDef.h"
     94          #include "hal_drivers.h"
     95          /*********************************************************************
     96           * MACROS
     97           */
     98          
     99          /*********************************************************************
    100           * CONSTANTS
    101           */
    102          
    103          /*********************************************************************
    104           * TYPEDEFS
    105           */
    106          // Message ID's for application user messages must be in 0xE0-0xEF range
    107          //#define ZB_USER_MSG                       0xE0
    108          #define SYSCB_DATA_CNF   0xE0
    109          //#define SAPICB_BIND_CNF   0xE1
    110          //#define SAPICB_START_CNF  0xE2
    111          
    112          /*********************************************************************
    113           * GLOBAL VARIABLES
    114           */

   \                                 In  segment XDATA_I, align 1, keep-with-next
    115          uint8 AppTitle[]="SensorAPP"; //应用程序名称
   \                     AppTitle:
   \   000000                DS 10
   \   00000A                REQUIRE `?<Initializer for AppTitle>`
   \   00000A                REQUIRE __INIT_XDATA_I
    116          
    117          // Sys 端点的簇ID
    118          // This list should be filled with Application specific Cluster IDs.

   \                                 In  segment XDATA_ROM_C, align 1
    119          const cId_t Sys_ClusterList[SYS_MAX_CLUSTERS] =
   \                     Sys_ClusterList:
   \   000000   0100         DW 1
    120          {
    121            SYS_CLUSTERID
    122          };
    123          

   \                                 In  segment XDATA_ROM_C, align 1
    124          const cId_t Zb_ClusterList[ZB_MAX_CLUSTERS] =
   \                     Zb_ClusterList:
   \   000000   0200         DW 2
    125          {
    126            ZB_CLUSTERID
    127          };
    128          
    129          // Sys 端点简单描述符

   \                                 In  segment XDATA_ROM_C, align 1
    130          const SimpleDescriptionFormat_t Sys_SimpleDesc =
   \                     Sys_SimpleDesc:
   \   000000   02           DB 2
   \   000001   040F         DW 3844
   \   000003   0100         DW 1
   \   000005   00           DB 0
   \   000006   01           DB 1
   \   000007   ....         DW Sys_ClusterList
   \   000009   00           DB 0
   \   00000A   0000         DW 0H
    131          {
    132          	SYS_ENDPOINT,           //  int Endpoint;
    133          	SYS_PROFID,                //  uint16 AppProfId[2];
    134          	SYS_DEVICEID,              //  uint16 AppDeviceId[2];
    135          	SYS_DEVICE_VERSION,        //  int   AppDevVer:4;
    136          	SYS_FLAGS,                 //  int   AppFlags:4;
    137          	SYS_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    138          	(cId_t *)Sys_ClusterList,  //  byte *pAppInClusterList;
    139          	0,                         //  byte  AppNumInClusters;
    140          	NULL   //  byte *pAppInClusterList;
    141          };
    142          

   \                                 In  segment XDATA_ROM_C, align 1
    143          const SimpleDescriptionFormat_t zb_SimpleDesc =
   \                     zb_SimpleDesc:
   \   000000   03           DB 3
   \   000001   040F         DW 3844
   \   000003   0100         DW 1
   \   000005   00           DB 0
   \   000006   01           DB 1
   \   000007   ....         DW Zb_ClusterList
   \   000009   01           DB 1
   \   00000A   ....         DW Zb_ClusterList
    144          {
    145          	ZB_ENDPOINT,           //  int Endpoint;
    146          	SYS_PROFID,                //  uint16 AppProfId[2];
    147          	SYS_DEVICEID,              //  uint16 AppDeviceId[2];
    148          	SYS_DEVICE_VERSION,        //  int   AppDevVer:4;
    149          	SYS_FLAGS,                 //  int   AppFlags:4;
    150          	ZB_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    151          	(cId_t *)Zb_ClusterList,  //  byte *pAppInClusterList;
    152          	ZB_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    153          	(cId_t *)Zb_ClusterList   //  byte *pAppInClusterList;
    154          };
    155          
    156          // This is the Endpoint/Interface description.  It is defined here, but
    157          // filled-in in Key_Init().  Another way to go would be to fill
    158          // in the structure here and make it a "const" (in code space).  The
    159          // way it's defined in this sample app it is define in RAM.

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    160          endPointDesc_t Sys_epDesc;
   \                     Sys_epDesc:
   \   000000                DS 6
   \   000006                REQUIRE __INIT_XDATA_Z
    161          
    162          /*********************************************************************
    163           * LOCAL VARIABLES
    164           */

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    165          uint8 myAppState = APP_INIT;
   \                     myAppState:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    166          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    167          byte Sys_TaskID;
   \                     Sys_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    168          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    169          devStates_t Sys_NwkState;   // 节点现在的网络状态
   \                     Sys_NwkState:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    170          
    171          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    172          byte Sys_TransID;  // 数据包的发送ID，每发一个自增1
   \                     Sys_TransID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    173          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    174          uint8 sysSeqNumber = 0;    // 在端点间数据交流时被使用zb_SendDataRequest
   \                     sysSeqNumber:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    175          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    176          uint16 sensor_bindInProgress;
   \                     sensor_bindInProgress:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    177          /*********************************************************************
    178           * LOCAL FUNCTIONS
    179           */
    180          void Sys_Init( byte task_id );
    181          
    182          UINT16 Sys_ProcessEvent( byte task_id, UINT16 events );
    183          
    184          void Sys_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg );
    185          
    186          void Sys_MessageMSGCB( afIncomingMSGPacket_t *pckt, byte task_id );
    187          void Sys_SendPreBindMessage( byte type_id );
    188          void Sys_SendDataRequest ( uint16 destination, endPointDesc_t *epDesc, uint16 commandId, uint8 len,
    189                                    uint8 *pData, uint8 handle, uint8 ack, uint8 radius );
    190          void Sys_SendCback( uint8 event, uint8 status, uint16 data );
    191          
    192          void Sys_SendDataConfirm( uint8 handle, uint8 status );
    193          /*********************************************************************
    194           * NETWORK LAYER CALLBACKS
    195           */
    196          
    197          /*********************************************************************
    198           * PUBLIC FUNCTIONS
    199           */
    200          
    201          /*********************************************************************
    202           * @fn      Sys_Init
    203           *
    204           * @brief   Initialization function for the Generic App Task.
    205           *          This is called during initialization and should contain
    206           *          any application specific initialization (ie. hardware
    207           *          initialization/setup, table initialization, power up
    208           *          notificaiton ... ).
    209           *
    210           * @param   task_id - the ID assigned by OSAL.  This ID should be
    211           *                    used to send messages and set timers.
    212           *
    213           * @return  none
    214           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    215          void Sys_Init( byte task_id )
   \                     Sys_Init:
    216          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
    217            Sys_TaskID = task_id;
   \   000007   90....       MOV     DPTR,#Sys_TaskID
   \   00000A   F0           MOVX    @DPTR,A
    218          
    219            // Fill out the endpoint description.
    220            Sys_epDesc.endPoint = SYS_ENDPOINT;
   \   00000B   90....       MOV     DPTR,#Sys_epDesc
   \   00000E   7402         MOV     A,#0x2
   \   000010   F0           MOVX    @DPTR,A
    221            Sys_epDesc.task_id = &Sys_TaskID;
   \   000011   A3           INC     DPTR
   \   000012   74..         MOV     A,#Sys_TaskID & 0xff
   \   000014   F0           MOVX    @DPTR,A
   \   000015   A3           INC     DPTR
   \   000016   74..         MOV     A,#(Sys_TaskID >> 8) & 0xff
   \   000018   F0           MOVX    @DPTR,A
    222            Sys_epDesc.simpleDesc
    223                      = (SimpleDescriptionFormat_t *)&Sys_SimpleDesc;
   \   000019   A3           INC     DPTR
   \   00001A   74..         MOV     A,#Sys_SimpleDesc & 0xff
   \   00001C   F0           MOVX    @DPTR,A
   \   00001D   A3           INC     DPTR
   \   00001E   74..         MOV     A,#(Sys_SimpleDesc >> 8) & 0xff
   \   000020   F0           MOVX    @DPTR,A
    224            Sys_epDesc.latencyReq = noLatencyReqs;
   \   000021   A3           INC     DPTR
   \   000022   E4           CLR     A
   \   000023   F0           MOVX    @DPTR,A
    225          
    226            // Register the endpoint description with the AF
    227            afRegister( &Sys_epDesc );
   \   000024                ; Setup parameters for call to function afRegister
   \   000024   7A..         MOV     R2,#Sys_epDesc & 0xff
   \   000026   7B..         MOV     R3,#(Sys_epDesc >> 8) & 0xff
   \   000028   12....       LCALL   ??afRegister?relay
    228          
    229            // Set device as Coordinator
    230            zgDeviceLogicalType = ZG_DEVICETYPE_COORDINATOR;
   \   00002B   90....       MOV     DPTR,#zgDeviceLogicalType
   \   00002E   E4           CLR     A
   \   00002F   F0           MOVX    @DPTR,A
    231          
    232            HalLedSet ( HAL_LED_1, HAL_LED_MODE_ON );
   \   000030                ; Setup parameters for call to function HalLedSet
   \   000030   12....       LCALL   ?Subroutine2 & 0xFFFF
    233            HalLedSet ( HAL_LED_2, HAL_LED_MODE_ON );
    234            HalLedSet ( HAL_LED_3, HAL_LED_MODE_ON );
    235            HalLedSet ( HAL_LED_4, HAL_LED_MODE_ON );
   \                     ??CrossCallReturnLabel_0:
   \   000033                ; Setup parameters for call to function HalLedSet
   \   000033   7A01         MOV     R2,#0x1
   \   000035   7908         MOV     R1,#0x8
   \   000037   12....       LCALL   ??HalLedSet?relay
    236            // To Initiallize
    237            // osal_start_timerEx(task_id, CONFIG_OPTION_EVT, 5000);
    238            
    239            // USE Bluetooth
    240            BluetoothInit(task_id);
   \   00003A                ; Setup parameters for call to function BluetoothInit
   \   00003A   EE           MOV     A,R6
   \   00003B   F9           MOV     R1,A
   \   00003C   12....       LCALL   ??BluetoothInit?relay
    241          }
   \   00003F                REQUIRE ?Subroutine0
   \   00003F                ; // Fall through to label ?Subroutine0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   7F01         MOV     R7,#0x1
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   7A01         MOV     R2,#0x1
   \   000002   7901         MOV     R1,#0x1
   \   000004   12....       LCALL   ??HalLedSet?relay
   \   000007                ; Setup parameters for call to function HalLedSet
   \   000007                ; Setup parameters for call to function HalLedSet
   \   000007   7A01         MOV     R2,#0x1
   \   000009   7902         MOV     R1,#0x2
   \   00000B   12....       LCALL   ??HalLedSet?relay
   \   00000E                ; Setup parameters for call to function HalLedSet
   \   00000E                ; Setup parameters for call to function HalLedSet
   \   00000E   7A01         MOV     R2,#0x1
   \   000010   7904         MOV     R1,#0x4
   \   000012   12....       LCALL   ??HalLedSet?relay
   \   000015   22           RET
    242          
    243          /*********************************************************************
    244           * @fn      Sys_ProcessEvent
    245           *
    246           * @brief   Generic Application Task event processor.  This function
    247           *          is called to process all events for the task.  Events
    248           *          include timers, messages and any other user defined events.
    249           *
    250           * @param   task_id  - The OSAL assigned task ID.
    251           * @param   events - events to process.  This is a bit map and can
    252           *                   contain more than one event.
    253           *
    254           * @return  none
    255           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    256          UINT16 Sys_ProcessEvent( byte task_id, UINT16 events )
   \                     Sys_ProcessEvent:
    257          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 2
   \   000005   74FE         MOV     A,#-0x2
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
    258            afIncomingMSGPacket_t *MSGpkt = NULL;
    259            afDataConfirm_t *afDataConfirm;
    260            
    261            // Data Confirmation message fields
    262            byte sentEP;
    263            ZStatus_t sentStatus;
    264            byte sentTransID;       // This should match the value sent
    265            (void)task_id;  // Intentionally unreferenced parameter
    266          
    267            if ( events & SYS_EVENT_MSG )
   \   00000E   5480         ANL     A,#0x80
   \   000010   6050         JZ      ??Sys_ProcessEvent_0
    268            {
    269              MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( task_id );
   \   000012                ; Setup parameters for call to function osal_msg_receive
   \   000012   8016         SJMP    ??Sys_ProcessEvent_1
    270              while ( MSGpkt )
    271              {
    272                switch ( MSGpkt->hdr.event )
    273                {
    274                  case ZDO_CB_MSG:  // 收到被绑定节点的rsp
    275                    Sys_ProcessZDOMsgs( (zdoIncomingMsg_t *)MSGpkt/*, task_id */);
    276                    break;
    277          
    278                  case AF_DATA_CONFIRM_CMD:
    279                    // This message is received as a confirmation of a data packet sent.
    280                    // The status is of ZStatus_t type [defined in ZComDef.h]
    281                    // The message fields are defined in AF.h
    282                    afDataConfirm = (afDataConfirm_t *)MSGpkt;
    283                    sentEP = afDataConfirm->endpoint;
    284                    sentStatus = afDataConfirm->hdr.status;
    285                    sentTransID = afDataConfirm->transID;
    286                    (void)sentEP;
    287                    (void)sentTransID;
    288          
    289                    // Action taken when confirmation is received.
    290                    if ( sentStatus != ZSuccess )
    291                    {
    292                      // The data wasn't delivered -- Do something
    293                    }
    294                    break;
    295          
    296                  case AF_INCOMING_MSG_CMD:
    297                    Sys_MessageMSGCB( MSGpkt, task_id );
    298                    break;
    299          
    300                  case ZDO_STATE_CHANGE:
    301                    Sys_NwkState = (devStates_t)(MSGpkt->hdr.status);
    302                    if ( (Sys_NwkState == DEV_ZB_COORD) )
    303                    {
    304                    //	if(myAppState == APP_INIT)
    305                    //    osal_start_timerEx( task_id, CLOSE_LIGHT_EVT, 1000);  // 1s 后关了所有的灯
    306                      ;
    307                    }
    308                    
    309                    break;
    310                    
    311                  case SYSCB_DATA_CNF:        // Data sent CoNFirm CallBack function
    312                    Sys_SendDataConfirm( (uint8)((sys_CbackEvent_t *)MSGpkt)->data,
    313                                              ((sys_CbackEvent_t *)MSGpkt)->hdr.status );
    314                    break;
    315                    
    316                  // Bluetooth cmd recived
    317                  case CMD_SERIAL_MSG:
    318                    Bluetooth_Handle(((mtOSALSerialData_t *)MSGpkt)->msg);
   \                     ??Sys_ProcessEvent_2:
   \   000014                ; Setup parameters for call to function Bluetooth_Handle
   \   000014   A3           INC     DPTR
   \   000015   A3           INC     DPTR
   \   000016   E0           MOVX    A,@DPTR
   \   000017   FA           MOV     R2,A
   \   000018   A3           INC     DPTR
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   FB           MOV     R3,A
   \   00001B   12....       LCALL   ??Bluetooth_Handle?relay
    319                    
    320                    break;
    321          
    322                  default:
    323                    break;
    324                }
    325          
    326                // Release the memory
    327                osal_msg_deallocate( (uint8 *)MSGpkt );
   \                     ??Sys_ProcessEvent_3:
   \   00001E                ; Setup parameters for call to function osal_msg_deallocate
   \   00001E   AA..         MOV     R2,?V0 + 0
   \   000020   AB..         MOV     R3,?V0 + 1
   \   000022   12....       LCALL   ??osal_msg_deallocate?relay
    328          
    329                // Next
    330                MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( Sys_TaskID );
   \   000025                ; Setup parameters for call to function osal_msg_receive
   \   000025   90....       MOV     DPTR,#Sys_TaskID
   \   000028   E0           MOVX    A,@DPTR
   \   000029   F9           MOV     R1,A
   \                     ??Sys_ProcessEvent_1:
   \   00002A   12....       LCALL   ??osal_msg_receive?relay
   \   00002D   8A..         MOV     ?V0 + 0,R2
   \   00002F   8B..         MOV     ?V0 + 1,R3
   \   000031   E5..         MOV     A,?V0 + 0
   \   000033   45..         ORL     A,?V0 + 1
   \   000035   6023         JZ      ??Sys_ProcessEvent_4
   \   000037   85..82       MOV     DPL,?V0 + 0
   \   00003A   85..83       MOV     DPH,?V0 + 1
   \   00003D   E0           MOVX    A,@DPTR
   \   00003E   14           DEC     A
   \   00003F   60D3         JZ      ??Sys_ProcessEvent_2
   \   000041   2430         ADD     A,#0x30
   \   000043   600D         JZ      ??Sys_ProcessEvent_5
   \   000045   24FE         ADD     A,#-0x2
   \   000047   70D5         JNZ     ??Sys_ProcessEvent_3
   \   000049                ; Setup parameters for call to function Sys_ProcessZDOMsgs
   \   000049   AA..         MOV     R2,?V0 + 0
   \   00004B   AB..         MOV     R3,?V0 + 1
   \   00004D   12....       LCALL   ??Sys_ProcessZDOMsgs?relay
   \   000050   80CC         SJMP    ??Sys_ProcessEvent_3
   \                     ??Sys_ProcessEvent_5:
   \   000052   A3           INC     DPTR
   \   000053   E0           MOVX    A,@DPTR
   \   000054   90....       MOV     DPTR,#Sys_NwkState
   \   000057   F0           MOVX    @DPTR,A
   \   000058   80C4         SJMP    ??Sys_ProcessEvent_3
    331              }
    332              // return unprocessed events
    333              return (events ^ SYS_EVENT_MSG);
   \                     ??Sys_ProcessEvent_4:
   \   00005A   EE           MOV     A,R6
   \   00005B   FA           MOV     R2,A
   \   00005C   EF           MOV     A,R7
   \   00005D   6480         XRL     A,#0x80
   \                     ??Sys_ProcessEvent_6:
   \   00005F   FB           MOV     R3,A
   \   000060   8072         SJMP    ??Sys_ProcessEvent_7
    334            }
    335          
    336            if( events & CONFIG_OPTION_EVT )
   \                     ??Sys_ProcessEvent_0:
   \   000062   EE           MOV     A,R6
   \   000063   5410         ANL     A,#0x10
   \   000065   605C         JZ      ??Sys_ProcessEvent_8
    337            {
    338              uint8 logicalType;
    339              uint8 startOptions;
    340              if ( myAppState == APP_INIT  )
   \   000067   90....       MOV     DPTR,#myAppState
   \   00006A   E0           MOVX    A,@DPTR
   \   00006B   704F         JNZ     ??Sys_ProcessEvent_9
    341              {
    342                zb_ReadConfiguration( ZCD_NV_LOGICAL_TYPE, sizeof(uint8), &logicalType );
   \   00006D                ; Setup parameters for call to function zb_ReadConfiguration
   \   00006D   85..82       MOV     DPL,?XSP + 0
   \   000070   85..83       MOV     DPH,?XSP + 1
   \   000073   AC82         MOV     R4,DPL
   \   000075   AD83         MOV     R5,DPH
   \   000077   7A01         MOV     R2,#0x1
   \   000079   7987         MOV     R1,#-0x79
   \   00007B   12....       LCALL   ??zb_ReadConfiguration?relay
    343                if ( logicalType != ZG_DEVICETYPE_ENDDEVICE )
   \   00007E   85..82       MOV     DPL,?XSP + 0
   \   000081   85..83       MOV     DPH,?XSP + 1
   \   000084   E0           MOVX    A,@DPTR
   \   000085   6402         XRL     A,#0x2
   \   000087   600D         JZ      ??Sys_ProcessEvent_10
    344                {
    345                  logicalType = ZG_DEVICETYPE_COORDINATOR;
   \   000089   E4           CLR     A
   \   00008A   F0           MOVX    @DPTR,A
    346                  zb_WriteConfiguration(ZCD_NV_LOGICAL_TYPE, sizeof(uint8), &logicalType);
   \   00008B                ; Setup parameters for call to function zb_WriteConfiguration
   \   00008B   AC82         MOV     R4,DPL
   \   00008D   AD83         MOV     R5,DPH
   \   00008F   7A01         MOV     R2,#0x1
   \   000091   7987         MOV     R1,#-0x79
   \   000093   12....       LCALL   ??zb_WriteConfiguration?relay
    347                }
    348                // Do more configuration if necessary and then restart device with auto-start bit set
    349                // write endpoint to simple desc...dont pass it in start req..then reset
    350          
    351                zb_ReadConfiguration( ZCD_NV_STARTUP_OPTION, sizeof(uint8), &startOptions );
   \                     ??Sys_ProcessEvent_10:
   \   000096                ; Setup parameters for call to function zb_ReadConfiguration
   \   000096   7401         MOV     A,#0x1
   \   000098   12....       LCALL   ?XSTACK_DISP0_8
   \   00009B   AC82         MOV     R4,DPL
   \   00009D   AD83         MOV     R5,DPH
   \   00009F   7A01         MOV     R2,#0x1
   \   0000A1   7903         MOV     R1,#0x3
   \   0000A3   12....       LCALL   ??zb_ReadConfiguration?relay
    352                startOptions = ZCD_STARTOPT_AUTO_START;
   \   0000A6   7401         MOV     A,#0x1
   \   0000A8   12....       LCALL   ?XSTACK_DISP0_8
   \   0000AB   7404         MOV     A,#0x4
   \   0000AD   F0           MOVX    @DPTR,A
    353                zb_WriteConfiguration( ZCD_NV_STARTUP_OPTION, sizeof(uint8), &startOptions );
   \   0000AE                ; Setup parameters for call to function zb_WriteConfiguration
   \   0000AE   AC82         MOV     R4,DPL
   \   0000B0   AD83         MOV     R5,DPH
   \   0000B2   7A01         MOV     R2,#0x1
   \   0000B4   7903         MOV     R1,#0x3
   \   0000B6   12....       LCALL   ??zb_WriteConfiguration?relay
    354                zb_SystemReset();
   \   0000B9                ; Setup parameters for call to function zb_SystemReset
   \   0000B9   12....       LCALL   ??zb_SystemReset?relay
    355              }
    356              return (events ^ CONFIG_OPTION_EVT);
   \                     ??Sys_ProcessEvent_9:
   \   0000BC   EE           MOV     A,R6
   \   0000BD   6410         XRL     A,#0x10
   \                     ??Sys_ProcessEvent_11:
   \   0000BF   FA           MOV     R2,A
   \   0000C0   EF           MOV     A,R7
   \   0000C1   809C         SJMP    ??Sys_ProcessEvent_6
    357            }
    358          
    359            if(events & CLOSE_LIGHT_EVT)
   \                     ??Sys_ProcessEvent_8:
   \   0000C3   EE           MOV     A,R6
   \   0000C4   5408         ANL     A,#0x8
   \   0000C6   6008         JZ      ??Sys_ProcessEvent_12
    360            {
    361              HalLedSet ( HAL_LED_1, HAL_LED_MODE_ON );
   \   0000C8                ; Setup parameters for call to function HalLedSet
   \   0000C8   12....       LCALL   ?Subroutine2 & 0xFFFF
    362              HalLedSet ( HAL_LED_2, HAL_LED_MODE_ON );
    363              HalLedSet ( HAL_LED_3, HAL_LED_MODE_ON );
    364              return (events ^ CLOSE_LIGHT_EVT);
   \                     ??CrossCallReturnLabel_1:
   \   0000CB   EE           MOV     A,R6
   \   0000CC   6408         XRL     A,#0x8
   \   0000CE   80EF         SJMP    ??Sys_ProcessEvent_11
    365            }
    366          
    367            // Discard unknown events
    368            return 0;
   \                     ??Sys_ProcessEvent_12:
   \   0000D0   7A00         MOV     R2,#0x0
   \   0000D2   7B00         MOV     R3,#0x0
   \                     ??Sys_ProcessEvent_7:
   \   0000D4   7402         MOV     A,#0x2
   \   0000D6   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000D9   7F06         MOV     R7,#0x6
   \   0000DB   02....       LJMP    ?BANKED_LEAVE_XDATA
    369          }
    370          
    371          /*********************************************************************
    372           * Event Generation Functions
    373           */
    374          
    375          /*********************************************************************
    376           * @fn      Sys_ProcessZDOMsgs()
    377           *
    378           * @brief   Process response messages
    379           *
    380           * @param   none
    381           *
    382           * @return  none
    383           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    384          void Sys_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg /*, byte task_id */)
   \                     Sys_ProcessZDOMsgs:
    385          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    386          
    387            switch ( inMsg->clusterID )
   \   000004   EA           MOV     A,R2
   \   000005   240C         ADD     A,#0xc
   \   000007   F582         MOV     DPL,A
   \   000009   EB           MOV     A,R3
   \   00000A   3400         ADDC    A,#0x0
   \   00000C   F583         MOV     DPH,A
   \   00000E   E0           MOVX    A,@DPTR
   \   00000F   6420         XRL     A,#0x20
   \   000011   7004         JNZ     ??Sys_ProcessZDOMsgs_0
   \   000013   A3           INC     DPTR
   \   000014   E0           MOVX    A,@DPTR
   \   000015   6480         XRL     A,#0x80
   \                     ??Sys_ProcessZDOMsgs_0:
   \   000017   701A         JNZ     ??Sys_ProcessZDOMsgs_1
    388            {
    389              case End_Device_Bind_rsp:
    390                if ( ZDO_ParseBindRsp( inMsg ) == ZSuccess )
   \   000019   EA           MOV     A,R2
   \   00001A   2413         ADD     A,#0x13
   \   00001C   F582         MOV     DPL,A
   \   00001E   EB           MOV     A,R3
   \   00001F   3400         ADDC    A,#0x0
   \   000021   F583         MOV     DPH,A
   \   000023   12....       LCALL   ?Subroutine3 & 0xFFFF
   \                     ??CrossCallReturnLabel_2:
   \   000026   7004         JNZ     ??Sys_ProcessZDOMsgs_2
    391                {
    392                  // Light LED
    393                  HalLedSet( HAL_LED_4, HAL_LED_MODE_ON );
   \   000028                ; Setup parameters for call to function HalLedSet
   \   000028   7A01         MOV     R2,#0x1
   \   00002A   8002         SJMP    ??Sys_ProcessZDOMsgs_3
    394                }
    395          #if defined(BLINK_LEDS)
    396                else
    397                {
    398                  // Flash LED to show failure
    399                  HalLedSet ( HAL_LED_4, HAL_LED_MODE_FLASH );
   \                     ??Sys_ProcessZDOMsgs_2:
   \   00002C                ; Setup parameters for call to function HalLedSet
   \   00002C   7A04         MOV     R2,#0x4
   \                     ??Sys_ProcessZDOMsgs_3:
   \   00002E   7908         MOV     R1,#0x8
   \   000030   12....       LCALL   ??HalLedSet?relay
    400                }
    401          #endif
    402                break;
    403            }
    404          }
   \                     ??Sys_ProcessZDOMsgs_1:
   \   000033                REQUIRE ?Subroutine1
   \   000033                ; // Fall through to label ?Subroutine1

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   D083         POP     DPH
   \   000002   D082         POP     DPL
   \   000004   02....       LJMP    ?BRET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine3:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   F8           MOV     R0,A
   \   000002   A3           INC     DPTR
   \   000003   E0           MOVX    A,@DPTR
   \   000004   F583         MOV     DPH,A
   \   000006   8882         MOV     DPL,R0
   \   000008   E0           MOVX    A,@DPTR
   \   000009   22           RET
    405          
    406          /*********************************************************************
    407           * LOCAL FUNCTIONS
    408           */
    409          
    410          /*********************************************************************
    411           * @fn      Sys_MessageMSGCB
    412           *
    413           * @brief   Data message processor callback.  This function processes
    414           *          any incoming data - probably from other devices.  So, based
    415           *          on cluster ID, perform the intended action.
    416           *
    417           * @param   none
    418           *
    419           * @return  none
    420           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    421          void Sys_MessageMSGCB( afIncomingMSGPacket_t *pkt, byte task_id )
   \                     Sys_MessageMSGCB:
    422          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    423            switch ( pkt->clusterId )
    424            {
    425              
    426            }
    427          }
   \   000000   02....       LJMP    ?BRET
    428          
    429          /*********************************************************************
    430           * @fn      Sys_SendPreBindMessage
    431           * * @brief   Broadcast prebind message.
    432           *
    433           *
    434           * @param   type_id : 想要绑定的终端类型
    435           *
    436           * @return  none
    437           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    438          void Sys_SendPreBindMessage( byte type_id )
   \                     Sys_SendPreBindMessage:
    439          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 18
   \   000005   74EE         MOV     A,#-0x12
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   E9           MOV     A,R1
   \   00000B   FE           MOV     R6,A
    440            afAddrType_t dstAddr;
    441          
    442            dstAddr.addr.shortAddr = 0xFFFF;
   \   00000C   7406         MOV     A,#0x6
   \   00000E   12....       LCALL   ?XSTACK_DISP0_8
   \   000011   74FF         MOV     A,#-0x1
   \   000013   F0           MOVX    @DPTR,A
   \   000014   A3           INC     DPTR
   \   000015   F0           MOVX    @DPTR,A
    443            dstAddr.addrMode = (afAddrMode_t)AddrBroadcast;
   \   000016   740E         MOV     A,#0xe
   \   000018   12....       LCALL   ?XSTACK_DISP0_8
   \   00001B   740F         MOV     A,#0xf
   \   00001D   F0           MOVX    @DPTR,A
    444            dstAddr.endPoint = Sys_epDesc.simpleDesc->EndPoint;
   \   00001E   90....       MOV     DPTR,#Sys_epDesc + 3
   \   000021   12....       LCALL   ?Subroutine3 & 0xFFFF
   \                     ??CrossCallReturnLabel_3:
   \   000024   C0E0         PUSH    A
   \   000026   740F         MOV     A,#0xf
   \   000028   12....       LCALL   ?XSTACK_DISP0_8
   \   00002B   D0E0         POP     A
   \   00002D   F0           MOVX    @DPTR,A
    445          
    446            char theMessageData[6] = "bind";
   \   00002E   85..82       MOV     DPL,?XSP + 0
   \   000031   85..83       MOV     DPH,?XSP + 1
   \   000034   AC82         MOV     R4,DPL
   \   000036   AD83         MOV     R5,DPH
   \   000038   7583..       MOV     DPH,#(`?<Constant "bind">` >> 8) & 0xff
   \   00003B   7582..       MOV     DPL,#`?<Constant "bind">` & 0xff
   \   00003E   7406         MOV     A,#0x6
   \   000040   12....       LCALL   ?MOVE_LONG8_XDATA_XDATA
    447            theMessageData[4] = type_id;
   \   000043   7404         MOV     A,#0x4
   \   000045   12....       LCALL   ?XSTACK_DISP0_8
   \   000048   E9           MOV     A,R1
   \   000049   F0           MOVX    @DPTR,A
    448          //  theMessageData[5] = ep_id;
    449            
    450            if ( AF_DataRequest( &dstAddr, &Sys_epDesc,
    451                                 SYS_CLUSTERID,
    452                                 (byte)osal_strlen( theMessageData ) + 1,
    453                                 (byte *)&theMessageData,
    454                                 &Sys_TransID,
    455                                 AF_DISCV_ROUTE, AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
   \   00004A                ; Setup parameters for call to function AF_DataRequest
   \   00004A   75..1E       MOV     ?V0 + 0,#0x1e
   \   00004D   78..         MOV     R0,#?V0 + 0
   \   00004F   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000052   75....       MOV     ?V0 + 0,#Sys_TransID & 0xff
   \   000055   75....       MOV     ?V0 + 1,#(Sys_TransID >> 8) & 0xff
   \   000058   78..         MOV     R0,#?V0 + 0
   \   00005A   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00005D   7403         MOV     A,#0x3
   \   00005F   12....       LCALL   ?XSTACK_DISP0_8
   \   000062   8582..       MOV     ?V0 + 0,DPL
   \   000065   8583..       MOV     ?V0 + 1,DPH
   \   000068   78..         MOV     R0,#?V0 + 0
   \   00006A   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00006D                ; Setup parameters for call to function osal_strlen
   \   00006D   7405         MOV     A,#0x5
   \   00006F   12....       LCALL   ?XSTACK_DISP0_8
   \   000072   AA82         MOV     R2,DPL
   \   000074   AB83         MOV     R3,DPH
   \   000076   12....       LCALL   ??osal_strlen?relay
   \   000079   EA           MOV     A,R2
   \   00007A   2401         ADD     A,#0x1
   \   00007C   F5..         MOV     ?V0 + 0,A
   \   00007E   E4           CLR     A
   \   00007F   3400         ADDC    A,#0x0
   \   000081   F5..         MOV     ?V0 + 1,A
   \   000083   78..         MOV     R0,#?V0 + 0
   \   000085   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000088   75..01       MOV     ?V0 + 0,#0x1
   \   00008B   75..00       MOV     ?V0 + 1,#0x0
   \   00008E   78..         MOV     R0,#?V0 + 0
   \   000090   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000093   7920         MOV     R1,#0x20
   \   000095   7C..         MOV     R4,#Sys_epDesc & 0xff
   \   000097   7D..         MOV     R5,#(Sys_epDesc >> 8) & 0xff
   \   000099   740F         MOV     A,#0xf
   \   00009B   12....       LCALL   ?XSTACK_DISP0_8
   \   00009E   AA82         MOV     R2,DPL
   \   0000A0   AB83         MOV     R3,DPH
   \   0000A2   12....       LCALL   ??AF_DataRequest?relay
   \   0000A5   7409         MOV     A,#0x9
   \   0000A7   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000AA   E9           MOV     A,R1
   \   0000AB   703A         JNZ     ??Sys_SendPreBindMessage_0
    456            {
    457              // Successfully requested to be sent.
    458              
    459              //(想要绑定什么就对应的 TypeID)
    460              switch(type_id)
   \   0000AD   EE           MOV     A,R6
   \   0000AE   14           DEC     A
   \   0000AF   6009         JZ      ??Sys_SendPreBindMessage_1
   \   0000B1   14           DEC     A
   \   0000B2   6016         JZ      ??Sys_SendPreBindMessage_2
   \   0000B4   24FE         ADD     A,#-0x2
   \   0000B6   601F         JZ      ??Sys_SendPreBindMessage_3
   \   0000B8   8034         SJMP    ??Sys_SendPreBindMessage_4
    461              {
    462                  case KEY_TYPE_ID:
    463                    osal_start_timerEx(Key_TaskID, MATCH_BIND_EVT, 5000);
   \                     ??Sys_SendPreBindMessage_1:
   \   0000BA                ; Setup parameters for call to function osal_start_timerEx
   \   0000BA   7C88         MOV     R4,#-0x78
   \   0000BC   7D13         MOV     R5,#0x13
   \   0000BE   7A02         MOV     R2,#0x2
   \   0000C0   7B00         MOV     R3,#0x0
   \   0000C2   90....       MOV     DPTR,#Key_TaskID
   \                     ??Sys_SendPreBindMessage_5:
   \   0000C5   12....       LCALL   ?Subroutine4 & 0xFFFF
    464                    break;
   \                     ??CrossCallReturnLabel_5:
   \   0000C8   8024         SJMP    ??Sys_SendPreBindMessage_4
    465                  
    466                  case MOTOR_TYPE_ID:
    467                    osal_start_timerEx(Motor_TaskID, MATCH_BIND_EVT, 5000);
   \                     ??Sys_SendPreBindMessage_2:
   \   0000CA                ; Setup parameters for call to function osal_start_timerEx
   \   0000CA   7C88         MOV     R4,#-0x78
   \   0000CC   7D13         MOV     R5,#0x13
   \   0000CE   7A02         MOV     R2,#0x2
   \   0000D0   7B00         MOV     R3,#0x0
   \   0000D2   90....       MOV     DPTR,#Motor_TaskID
   \   0000D5   80EE         SJMP    ??Sys_SendPreBindMessage_5
    468                    break;
    469                    
    470                  case SWITCH_TYPE_ID:
    471                    osal_start_timerEx(Switch_TaskID, MATCH_BIND_EVT, 5000);
   \                     ??Sys_SendPreBindMessage_3:
   \   0000D7                ; Setup parameters for call to function osal_start_timerEx
   \   0000D7   7C88         MOV     R4,#-0x78
   \   0000D9   7D13         MOV     R5,#0x13
   \   0000DB   7A02         MOV     R2,#0x2
   \   0000DD   7B00         MOV     R3,#0x0
   \   0000DF   90....       MOV     DPTR,#Switch_TaskID
   \   0000E2   12....       LCALL   ?Subroutine4 & 0xFFFF
    472                    break;
   \                     ??CrossCallReturnLabel_6:
   \   0000E5   8007         SJMP    ??Sys_SendPreBindMessage_4
    473              }
    474            }
    475            else
    476            {
    477              // Error occurred in request to send.
    478              HalLedSet(HAL_LED_1, HAL_LED_MODE_OFF);
   \                     ??Sys_SendPreBindMessage_0:
   \   0000E7                ; Setup parameters for call to function HalLedSet
   \   0000E7   7A00         MOV     R2,#0x0
   \   0000E9   7901         MOV     R1,#0x1
   \   0000EB   12....       LCALL   ??HalLedSet?relay
    479            }
    480          }
   \                     ??Sys_SendPreBindMessage_4:
   \   0000EE   7412         MOV     A,#0x12
   \   0000F0   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000F3   7F02         MOV     R7,#0x2
   \   0000F5   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine4:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   F9           MOV     R1,A
   \   000002   12....       LCALL   ??osal_start_timerEx?relay
   \   000005   22           RET
    481          
    482          /******************************************************************************
    483           * @fn          Sys_SendDataRequest
    484           *
    485           * @brief       The Sys_SendDataRequest function initiates transmission of data
    486           *              to a peer device
    487           *
    488           * @param       destination - The destination of the data.  The destination can
    489           *                            be one of the following:
    490           *                            - 16-Bit short address of device [0-0xfffD]
    491           *                            - ZB_BROADCAST_ADDR sends the data to all devices
    492           *                              in the network.
    493           *                            - ZB_BINDING_ADDR sends the data to a previously
    494           *                              bound device.
    495           *
    496           *              commandId - The command ID to send with the message.  If the
    497           *                          SYS_BINDING_ADDR destination is used, this parameter
    498           *                          also indicates the binding to use.
    499           *
    500           *              len - The size of the pData buffer in bytes
    501           *              handle - A handle used to identify the send data request.
    502           *              txOptions - TRUE if requesting acknowledgement from the destination.
    503           *              radius - The max number of hops the packet can travel through
    504           *                       before it is dropped.
    505           *
    506           * @return      none
    507           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    508          void Sys_SendDataRequest ( uint16 destination, endPointDesc_t *epDesc, uint16 commandId, uint8 len,
   \                     Sys_SendDataRequest:
    509                                    uint8 *pData, uint8 handle, uint8 txOptions, uint8 radius )
    510          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 12
   \   000005   74F4         MOV     A,#-0xc
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EC           MOV     A,R4
   \   00000B   FE           MOV     R6,A
   \   00000C   ED           MOV     A,R5
   \   00000D   FF           MOV     R7,A
   \   00000E   89..         MOV     ?V0 + 7,R1
   \   000010   741C         MOV     A,#0x1c
   \   000012   12....       LCALL   ?XSTACK_DISP0_8
   \   000015   E0           MOVX    A,@DPTR
   \   000016   F5..         MOV     ?V0 + 2,A
   \   000018   A3           INC     DPTR
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   F5..         MOV     ?V0 + 3,A
   \   00001C   741E         MOV     A,#0x1e
   \   00001E   12....       LCALL   ?XSTACK_DISP0_8
   \   000021   E0           MOVX    A,@DPTR
   \   000022   F5..         MOV     ?V0 + 4,A
   \   000024   A3           INC     DPTR
   \   000025   E0           MOVX    A,@DPTR
   \   000026   F5..         MOV     ?V0 + 5,A
   \   000028   7421         MOV     A,#0x21
   \   00002A   12....       LCALL   ?XSTACK_DISP0_8
   \   00002D   E0           MOVX    A,@DPTR
   \   00002E   F5..         MOV     ?V0 + 6,A
   \   000030   7422         MOV     A,#0x22
   \   000032   12....       LCALL   ?XSTACK_DISP0_8
   \   000035   E0           MOVX    A,@DPTR
   \   000036   F5..         MOV     ?V0 + 0,A
    511            afStatus_t status;
    512            afAddrType_t dstAddr;
    513          
    514            txOptions |= AF_DISCV_ROUTE;
   \   000038   E5..         MOV     A,?V0 + 6
   \   00003A   D2E5         SETB    0xE0 /* A   */.5
   \   00003C   F5..         MOV     ?V0 + 6,A
    515          
    516            // Set the destination address
    517            if (destination == SYS_BINDING_ADDR)
   \   00003E   74FE         MOV     A,#-0x2
   \   000040   6A           XRL     A,R2
   \   000041   7003         JNZ     ??Sys_SendDataRequest_0
   \   000043   74FF         MOV     A,#-0x1
   \   000045   6B           XRL     A,R3
   \                     ??Sys_SendDataRequest_0:
   \   000046   7009         JNZ     ??Sys_SendDataRequest_1
    518            {
    519              // Binding
    520              dstAddr.addrMode = afAddrNotPresent;
   \   000048   7408         MOV     A,#0x8
   \   00004A   12....       LCALL   ?XSTACK_DISP0_8
   \   00004D   E4           CLR     A
   \   00004E   F0           MOVX    @DPTR,A
   \   00004F   801F         SJMP    ??Sys_SendDataRequest_2
    521            } 
    522            else
    523            {
    524              // Use short address
    525              dstAddr.addr.shortAddr = destination;
   \                     ??Sys_SendDataRequest_1:
   \   000051   85..82       MOV     DPL,?XSP + 0
   \   000054   85..83       MOV     DPH,?XSP + 1
   \   000057   EA           MOV     A,R2
   \   000058   F0           MOVX    @DPTR,A
   \   000059   A3           INC     DPTR
   \   00005A   EB           MOV     A,R3
   \   00005B   F0           MOVX    @DPTR,A
    526              dstAddr.addrMode = afAddr16Bit;
   \   00005C   7408         MOV     A,#0x8
   \   00005E   12....       LCALL   ?XSTACK_DISP0_8
   \   000061   7402         MOV     A,#0x2
   \   000063   F0           MOVX    @DPTR,A
    527          
    528              if ( ADDR_NOT_BCAST != NLME_IsAddressBroadcast( destination ) )
   \   000064                ; Setup parameters for call to function NLME_IsAddressBroadcast
   \   000064   12....       LCALL   ??NLME_IsAddressBroadcast?relay
   \   000067   E9           MOV     A,R1
   \   000068   6006         JZ      ??Sys_SendDataRequest_2
    529              {
    530                txOptions &= ~AF_ACK_REQUEST;
   \   00006A   E5..         MOV     A,?V0 + 6
   \   00006C   C2E4         CLR     0xE0 /* A   */.4
   \   00006E   F5..         MOV     ?V0 + 6,A
    531              }
    532            }
    533          
    534            dstAddr.panId = 0;                                    // Not an inter-pan message.
   \                     ??Sys_SendDataRequest_2:
   \   000070   740A         MOV     A,#0xa
   \   000072   12....       LCALL   ?XSTACK_DISP0_8
   \   000075   E4           CLR     A
   \   000076   F0           MOVX    @DPTR,A
   \   000077   A3           INC     DPTR
   \   000078   F0           MOVX    @DPTR,A
    535            dstAddr.endPoint = epDesc->simpleDesc->EndPoint;  // Set the endpoint.
   \   000079   8E82         MOV     DPL,R6
   \   00007B   8F83         MOV     DPH,R7
   \   00007D   A3           INC     DPTR
   \   00007E   A3           INC     DPTR
   \   00007F   A3           INC     DPTR
   \   000080   12....       LCALL   ?Subroutine3 & 0xFFFF
   \                     ??CrossCallReturnLabel_4:
   \   000083   C0E0         PUSH    A
   \   000085   7409         MOV     A,#0x9
   \   000087   12....       LCALL   ?XSTACK_DISP0_8
   \   00008A   D0E0         POP     A
   \   00008C   F0           MOVX    @DPTR,A
    536          
    537            
    538            // Send the message
    539            status = AF_DataRequest(&dstAddr, epDesc, commandId, len,
    540                                    pData, &handle, txOptions, radius);
   \   00008D                ; Setup parameters for call to function AF_DataRequest
   \   00008D   78..         MOV     R0,#?V0 + 0
   \   00008F   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000092   7421         MOV     A,#0x21
   \   000094   12....       LCALL   ?XSTACK_DISP0_8
   \   000097   8582..       MOV     ?V0 + 0,DPL
   \   00009A   8583..       MOV     ?V0 + 1,DPH
   \   00009D   78..         MOV     R0,#?V0 + 0
   \   00009F   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000A2   78..         MOV     R0,#?V0 + 4
   \   0000A4   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000A7   85....       MOV     ?V0 + 0,?V0 + 7
   \   0000AA   75..00       MOV     ?V0 + 1,#0x0
   \   0000AD   78..         MOV     R0,#?V0 + 0
   \   0000AF   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000B2   78..         MOV     R0,#?V0 + 2
   \   0000B4   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000B7   A9..         MOV     R1,?V0 + 6
   \   0000B9   EE           MOV     A,R6
   \   0000BA   FC           MOV     R4,A
   \   0000BB   EF           MOV     A,R7
   \   0000BC   FD           MOV     R5,A
   \   0000BD   7409         MOV     A,#0x9
   \   0000BF   12....       LCALL   ?XSTACK_DISP0_8
   \   0000C2   AA82         MOV     R2,DPL
   \   0000C4   AB83         MOV     R3,DPH
   \   0000C6   12....       LCALL   ??AF_DataRequest?relay
   \   0000C9   7409         MOV     A,#0x9
   \   0000CB   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000CE   E9           MOV     A,R1
   \   0000CF   FA           MOV     R2,A
    541          
    542            if (status != afStatus_SUCCESS)
   \   0000D0   600E         JZ      ??Sys_SendDataRequest_3
    543            {
    544              Sys_SendCback( SYSCB_DATA_CNF, status, handle );
   \   0000D2                ; Setup parameters for call to function Sys_SendCback
   \   0000D2   7420         MOV     A,#0x20
   \   0000D4   12....       LCALL   ?XSTACK_DISP0_8
   \   0000D7   E0           MOVX    A,@DPTR
   \   0000D8   FC           MOV     R4,A
   \   0000D9   7D00         MOV     R5,#0x0
   \   0000DB   79E0         MOV     R1,#-0x20
   \   0000DD   12....       LCALL   ??Sys_SendCback?relay
    545            }
    546          }
   \                     ??Sys_SendDataRequest_3:
   \   0000E0   740C         MOV     A,#0xc
   \   0000E2   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000E5   7F08         MOV     R7,#0x8
   \   0000E7   02....       LJMP    ?BANKED_LEAVE_XDATA
    547          
    548          /*********************************************************************
    549          *********************************************************************/
    550          
    551          
    552          /******************************************************************************
    553           * @fn          zb_StartConfirm
    554           *
    555           * @brief       The zb_StartConfirm callback is called by the ZigBee stack
    556           *              after a start request operation completes
    557           *
    558           * @param       status - The status of the start operation.  Status of
    559           *                       ZB_SUCCESS indicates the start operation completed
    560           *                       successfully.  Else the status is an error code.
    561           *
    562           * @return      none
    563           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    564          void zb_StartConfirm( uint8 status )
   \                     zb_StartConfirm:
    565          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    566            if ( status == ZB_SUCCESS )
    567            {
    568          //    myAppState = APP_START;
    569            }
    570            else
    571            {
    572              // Try again later with a delay
    573            }
    574          }
   \   000000   02....       LJMP    ?BRET
    575          
    576          /******************************************************************************
    577           * @fn          zb_FindDeviceConfirm
    578           *
    579           * @brief       The zb_FindDeviceConfirm callback function is called by the
    580           *              ZigBee stack when a find device operation completes.
    581           *
    582           * @param       searchType - The type of search that was performed.
    583           *              searchKey - Value that the search was executed on.
    584           *              result - The result of the search.
    585           *
    586           * @return      none
    587           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    588          void zb_FindDeviceConfirm( uint8 searchType, uint8 *searchKey, uint8 *result )
   \                     zb_FindDeviceConfirm:
    589          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    590          }
   \   000000   02....       LJMP    ?BRET
    591          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    592          void zb_HandleOsalEvent( uint16 event )
   \                     zb_HandleOsalEvent:
    593          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    594            if ( event & MY_START_EVT )
   \   000004   EA           MOV     A,R2
   \   000005   5411         ANL     A,#0x11
   \   000007   6003         JZ      ??zb_HandleOsalEvent_0
    595            {
    596              zb_StartRequest();
   \   000009                ; Setup parameters for call to function zb_StartRequest
   \   000009   12....       LCALL   ??zb_StartRequest?relay
    597            }
    598          }
   \                     ??zb_HandleOsalEvent_0:
   \   00000C   02....       LJMP    ?Subroutine1 & 0xFFFF
    599          /*********************************************************************
    600           * CBack FUNCTIONS
    601           */
    602          
    603          /*********************************************************************
    604           * @fn      SAPI_SendCback
    605           *
    606           * @brief   Sends a message to the sapi task ( itself ) so that a
    607           *           callback can be generated later.
    608           *
    609           * @return  none
    610           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    611          void Sys_SendCback( uint8 event, uint8 status, uint16 data )
   \                     Sys_SendCback:
    612          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   \   000007   8A..         MOV     ?V0 + 1,R2
   \   000009   EC           MOV     A,R4
   \   00000A   FE           MOV     R6,A
   \   00000B   ED           MOV     A,R5
   \   00000C   FF           MOV     R7,A
    613            sapi_CbackEvent_t *pMsg;
    614          
    615            pMsg = (sapi_CbackEvent_t *)osal_msg_allocate( sizeof(sapi_CbackEvent_t) );
   \   00000D                ; Setup parameters for call to function osal_msg_allocate
   \   00000D   7A04         MOV     R2,#0x4
   \   00000F   7B00         MOV     R3,#0x0
   \   000011   12....       LCALL   ??osal_msg_allocate?relay
    616            if( pMsg )
   \   000014   EA           MOV     A,R2
   \   000015   4B           ORL     A,R3
   \   000016   601E         JZ      ??Sys_SendCback_0
    617            {
    618              pMsg->hdr.event = event;
   \   000018   8A82         MOV     DPL,R2
   \   00001A   8B83         MOV     DPH,R3
   \   00001C   E5..         MOV     A,?V0 + 0
   \   00001E   F0           MOVX    @DPTR,A
    619              pMsg->hdr.status = status;
   \   00001F   A3           INC     DPTR
   \   000020   E5..         MOV     A,?V0 + 1
   \   000022   F0           MOVX    @DPTR,A
    620              pMsg->data = data;
   \   000023   8A82         MOV     DPL,R2
   \   000025   8B83         MOV     DPH,R3
   \   000027   A3           INC     DPTR
   \   000028   A3           INC     DPTR
   \   000029   EE           MOV     A,R6
   \   00002A   F0           MOVX    @DPTR,A
   \   00002B   A3           INC     DPTR
   \   00002C   EF           MOV     A,R7
   \   00002D   F0           MOVX    @DPTR,A
    621          
    622              osal_msg_send( Sys_TaskID, (uint8 *)pMsg );
   \   00002E                ; Setup parameters for call to function osal_msg_send
   \   00002E   90....       MOV     DPTR,#Sys_TaskID
   \   000031   E0           MOVX    A,@DPTR
   \   000032   F9           MOV     R1,A
   \   000033   12....       LCALL   ??osal_msg_send?relay
    623            }
    624          
    625          }
   \                     ??Sys_SendCback_0:
   \   000036   7F04         MOV     R7,#0x4
   \   000038   02....       LJMP    ?BANKED_LEAVE_XDATA
    626          
    627          
    628          
    629          /******************************************************************************
    630           * CONFIRM FUNCTIONS 
    631           */
    632          
    633          /******************************************************************************
    634           * @fn          Sys_BindConfirm
    635           *
    636           * @brief       The Sys_BindConfirm callback is called by the ZigBee stack
    637           *              after a bind operation completes.
    638           *
    639           * @param       endpoint - The endpoint of the binding being confirmed.
    640           *              src - The 16-bit srcAddr of the binding being confirmed.
    641           *              status - The status of the bind operation.
    642           *
    643           * @return      none
    644           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    645          void Sys_BindConfirm( uint16 commandId, uint8 status )
   \                     Sys_BindConfirm:
    646          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
    647            if( status == ZB_SUCCESS)
   \   000006   7A01         MOV     R2,#0x1
   \   000008   701C         JNZ     ??Sys_BindConfirm_0
    648            {
    649              // Light D2
    650              HalLedSet(HAL_LED_3, HAL_LED_MODE_ON);
   \   00000A                ; Setup parameters for call to function HalLedSet
   \   00000A   7904         MOV     R1,#0x4
   \   00000C   12....       LCALL   ??HalLedSet?relay
    651              HalLedSet(HAL_LED_2, HAL_LED_MODE_OFF);
   \   00000F                ; Setup parameters for call to function HalLedSet
   \   00000F   7A00         MOV     R2,#0x0
   \   000011   7902         MOV     R1,#0x2
   \   000013   12....       LCALL   ??HalLedSet?relay
    652              /*  // Search Enddevice's ieee64
    653              ZLongAddr_t ext64;
    654              if(APSME_LookupNwkAddr( ext64, src ) == TRUE)
    655              {
    656                  SearchExtChain(ext64);
    657              }
    658              else
    659              {
    660               // Faild
    661                return;
    662              }
    663             */
    664              osal_start_timerEx(Sys_TaskID, CLOSE_LIGHT_EVT, 5000);
   \   000016                ; Setup parameters for call to function osal_start_timerEx
   \   000016   7C88         MOV     R4,#-0x78
   \   000018   7D13         MOV     R5,#0x13
   \   00001A   7A08         MOV     R2,#0x8
   \   00001C   7B00         MOV     R3,#0x0
   \   00001E   90....       MOV     DPTR,#Sys_TaskID
   \   000021   12....       LCALL   ?Subroutine4 & 0xFFFF
    665            }
   \                     ??CrossCallReturnLabel_7:
   \   000024   800C         SJMP    ??Sys_BindConfirm_1
    666            else
    667            {
    668              // Light D3
    669              HalLedSet(HAL_LED_2, HAL_LED_MODE_ON);
   \                     ??Sys_BindConfirm_0:
   \   000026                ; Setup parameters for call to function HalLedSet
   \   000026   7902         MOV     R1,#0x2
   \   000028   12....       LCALL   ??HalLedSet?relay
    670              HalLedSet(HAL_LED_3, HAL_LED_MODE_OFF);
   \   00002B                ; Setup parameters for call to function HalLedSet
   \   00002B   7A00         MOV     R2,#0x0
   \   00002D   7904         MOV     R1,#0x4
   \   00002F   12....       LCALL   ??HalLedSet?relay
    671            }
    672          }
   \                     ??Sys_BindConfirm_1:
   \   000032   02....       LJMP    ?Subroutine0 & 0xFFFF
    673          
    674          /******************************************************************************
    675           * @fn          Sys_SendDataConfirm
    676           *
    677           * @brief       The zb_SendDataConfirm callback function is called by the
    678           *              ZigBee after a send data operation completes
    679           *
    680           * @param       handle - The handle identifying the data transmission.
    681           *              status - The status of the operation.
    682           *
    683           * @return      none
    684           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    685          void Sys_SendDataConfirm( uint8 handle, uint8 status )
   \                     Sys_SendDataConfirm:
    686          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    687          }
   \   000000   02....       LJMP    ?BRET
    688          
    689          /*******************************************************************************
    690           *******************************************************************************
    691           * CONFIGURATIONS
    692           ******************************************************************************/
    693          
    694          // The order in this table must be identical to the task initialization calls below in osalInitTask.
    695          

   \                                 In  segment XDATA_ROM_C, align 1
    696          const pTaskEventHandlerFn tasksArr[] = {
   \                     tasksArr:
   \   000000   ....         DW ??macEventLoop?relay
   \   000002   ....         DW ??nwk_event_loop?relay
   \   000004   ....         DW ??Hal_ProcessEvent?relay
   \   000006   ....         DW ??APS_event_loop?relay
   \   000008   ....         DW ??ZDApp_event_loop?relay
   \   00000A   ....         DW ??Sys_ProcessEvent?relay
   \   00000C   ....         DW ??Key_ProcessEvent?relay
   \   00000E   ....         DW ??Motor_ProcessEvent?relay
   \   000010   ....         DW ??Switch_ProcessEvent?relay
   \   000012   ....         DW ??SAPI_ProcessEvent?relay
    697            macEventLoop,
    698            nwk_event_loop,
    699            Hal_ProcessEvent,
    700          #if defined( MT_TASK )
    701            MT_ProcessEvent,
    702          #endif
    703            APS_event_loop,
    704            ZDApp_event_loop,
    705          
    706            Sys_ProcessEvent,
    707            Key_ProcessEvent,
    708            Motor_ProcessEvent,
    709            Switch_ProcessEvent,
    710            SAPI_ProcessEvent
    711          };
    712          

   \                                 In  segment XDATA_ROM_C, align 1
    713          const uint8 tasksCnt = sizeof( tasksArr ) / sizeof( tasksArr[0] );
   \                     tasksCnt:
   \   000000   0A           DB 10

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    714          uint16 *tasksEvents;
   \                     tasksEvents:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    715          
    716          
    717          
    718          /*********************************************************************
    719           * @fn      osalInitTasks
    720           *
    721           * @brief   This function invokes the initialization function for each task.
    722           *
    723           * @param   void
    724           *
    725           * @return  none
    726           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    727          void osalInitTasks( void )
   \                     osalInitTasks:
    728          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    729            uint8 taskID = 0;
    730          
    731            tasksEvents = (uint16 *)osal_mem_alloc( sizeof( uint16 ) * tasksCnt);
   \   000004                ; Setup parameters for call to function osal_mem_alloc
   \   000004   7A14         MOV     R2,#0x14
   \   000006   7B00         MOV     R3,#0x0
   \   000008   12....       LCALL   ??osal_mem_alloc?relay
   \   00000B   90....       MOV     DPTR,#tasksEvents
   \   00000E   EA           MOV     A,R2
   \   00000F   F0           MOVX    @DPTR,A
   \   000010   A3           INC     DPTR
   \   000011   EB           MOV     A,R3
   \   000012   F0           MOVX    @DPTR,A
    732            osal_memset( tasksEvents, 0, (sizeof( uint16 ) * tasksCnt));
   \   000013                ; Setup parameters for call to function osal_memset
   \   000013   7C14         MOV     R4,#0x14
   \   000015   7D00         MOV     R5,#0x0
   \   000017   7900         MOV     R1,#0x0
   \   000019   12....       LCALL   ??osal_memset?relay
    733          
    734            macTaskInit( taskID++ );
   \   00001C                ; Setup parameters for call to function macTaskInit
   \   00001C   7900         MOV     R1,#0x0
   \   00001E   12....       LCALL   ??macTaskInit?relay
    735            nwk_init( taskID++ );
   \   000021                ; Setup parameters for call to function nwk_init
   \   000021   7901         MOV     R1,#0x1
   \   000023   12....       LCALL   ??nwk_init?relay
    736            Hal_Init( taskID++ );
   \   000026                ; Setup parameters for call to function Hal_Init
   \   000026   7902         MOV     R1,#0x2
   \   000028   12....       LCALL   ??Hal_Init?relay
    737          #if defined( MT_TASK )
    738            MT_TaskInit( taskID++ );
    739          #endif
    740            APS_Init( taskID++ );
   \   00002B                ; Setup parameters for call to function APS_Init
   \   00002B   7903         MOV     R1,#0x3
   \   00002D   12....       LCALL   ??APS_Init?relay
    741            ZDApp_Init( taskID++ );
   \   000030                ; Setup parameters for call to function ZDApp_Init
   \   000030   7904         MOV     R1,#0x4
   \   000032   12....       LCALL   ??ZDApp_Init?relay
    742            Sys_Init( taskID++ );
   \   000035                ; Setup parameters for call to function Sys_Init
   \   000035   7905         MOV     R1,#0x5
   \   000037   12....       LCALL   ??Sys_Init?relay
    743            Key_Init( taskID++ );
   \   00003A                ; Setup parameters for call to function Key_Init
   \   00003A   7906         MOV     R1,#0x6
   \   00003C   12....       LCALL   ??Key_Init?relay
    744            Motor_Init( taskID++ );
   \   00003F                ; Setup parameters for call to function Motor_Init
   \   00003F   7907         MOV     R1,#0x7
   \   000041   12....       LCALL   ??Motor_Init?relay
    745            Switch_Init( taskID++ );
   \   000044                ; Setup parameters for call to function Switch_Init
   \   000044   7908         MOV     R1,#0x8
   \   000046   12....       LCALL   ??Switch_Init?relay
    746            SAPI_Init( taskID );
   \   000049                ; Setup parameters for call to function SAPI_Init
   \   000049   7909         MOV     R1,#0x9
   \   00004B   12....       LCALL   ??SAPI_Init?relay
    747          }
   \   00004E   02....       LJMP    ?Subroutine1 & 0xFFFF

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for AppTitle>`:
   \   000000   53656E73     DB "SensorAPP"
   \            6F724150
   \            5000    

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Sys_Init?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Sys_Init

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Sys_ProcessEvent?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Sys_ProcessEvent

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Sys_ProcessZDOMsgs?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Sys_ProcessZDOMsgs

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Sys_MessageMSGCB?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Sys_MessageMSGCB

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Sys_SendPreBindMessage?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Sys_SendPreBindMessage

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Sys_SendDataRequest?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Sys_SendDataRequest

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zb_StartConfirm?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zb_StartConfirm

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zb_FindDeviceConfirm?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zb_FindDeviceConfirm

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zb_HandleOsalEvent?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zb_HandleOsalEvent

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Sys_SendCback?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Sys_SendCback

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Sys_BindConfirm?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Sys_BindConfirm

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Sys_SendDataConfirm?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Sys_SendDataConfirm

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??osalInitTasks?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    osalInitTasks

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "bind">`:
   \   000000   62696E64     DB "bind"
   \            00      
   \   000005   00           DB 0

   Maximum stack usage in bytes:

     Function                     ISTACK PSTACK XSTACK
     --------                     ------ ------ ------
     Sys_BindConfirm                  0      0      9
       -> HalLedSet                   0      0     18
       -> HalLedSet                   0      0     18
       -> osal_start_timerEx          0      0     18
       -> HalLedSet                   0      0     18
       -> HalLedSet                   0      0     18
     Sys_Init                         0      0      9
       -> afRegister                  0      0     18
       -> HalLedSet                   0      0     18
       -> HalLedSet                   0      0     18
       -> HalLedSet                   0      0     18
       -> HalLedSet                   0      0     18
       -> BluetoothInit               0      0     18
     Sys_MessageMSGCB                 0      0      0
     Sys_ProcessEvent                 0      0     16
       -> osal_msg_receive            0      0     32
       -> Bluetooth_Handle            0      0     32
       -> osal_msg_deallocate         0      0     32
       -> osal_msg_receive            0      0     32
       -> Sys_ProcessZDOMsgs          0      0     32
       -> zb_ReadConfiguration        0      0     32
       -> zb_WriteConfiguration       0      0     32
       -> zb_ReadConfiguration        0      0     32
       -> zb_WriteConfiguration       0      0     32
       -> zb_SystemReset              0      0     32
       -> HalLedSet                   0      0     32
       -> HalLedSet                   0      0     32
       -> HalLedSet                   0      0     32
     Sys_ProcessZDOMsgs               2      0     16
       -> HalLedSet                   4      0      0
       -> HalLedSet                   4      0      0
     Sys_SendCback                    1      0     40
       -> osal_msg_allocate           0      0     24
       -> osal_msg_send               0      0     24
     Sys_SendDataConfirm              0      0      0
     Sys_SendDataRequest              1      0     44
       -> NLME_IsAddressBroadcast     0      0     56
       -> AF_DataRequest              0      0     74
       -> Sys_SendCback               0      0     56
     Sys_SendPreBindMessage           2      0     37
       -> osal_strlen                 0      0     66
       -> AF_DataRequest              0      0     74
       -> osal_start_timerEx          0      0     56
       -> osal_start_timerEx          0      0     56
       -> osal_start_timerEx          0      0     56
       -> HalLedSet                   0      0     56
     osalInitTasks                    2      0      0
       -> osal_mem_alloc              4      0      0
       -> osal_memset                 4      0      0
       -> macTaskInit                 4      0      0
       -> nwk_init                    4      0      0
       -> Hal_Init                    4      0      0
       -> APS_Init                    4      0      0
       -> ZDApp_Init                  4      0      0
       -> Sys_Init                    4      0      0
       -> Key_Init                    4      0      0
       -> Motor_Init                  4      0      0
       -> Switch_Init                 4      0      0
       -> SAPI_Init                   4      0      0
     zb_FindDeviceConfirm             0      0      0
     zb_HandleOsalEvent               2      0      0
       -> zb_StartRequest             4      0      0
     zb_StartConfirm                  0      0      0


   Segment part sizes:

     Function/Label                 Bytes
     --------------                 -----
     AppTitle                         10
     Sys_ClusterList                   2
     Zb_ClusterList                    2
     Sys_SimpleDesc                   12
     zb_SimpleDesc                    12
     Sys_epDesc                        6
     myAppState                        1
     Sys_TaskID                        1
     Sys_NwkState                      1
     Sys_TransID                       1
     sysSeqNumber                      1
     sensor_bindInProgress             2
     Sys_Init                         63
     ?Subroutine0                      5
     ?Subroutine2                     22
     Sys_ProcessEvent                222
     Sys_ProcessZDOMsgs               51
     ?Subroutine1                      7
     ?Subroutine3                     10
     Sys_MessageMSGCB                  3
     Sys_SendPreBindMessage          248
     ?Subroutine4                      6
     Sys_SendDataRequest             234
     zb_StartConfirm                   3
     zb_FindDeviceConfirm              3
     zb_HandleOsalEvent               15
     Sys_SendCback                    59
     Sys_BindConfirm                  53
     Sys_SendDataConfirm               3
     tasksArr                         20
     tasksCnt                          1
     tasksEvents                       2
     osalInitTasks                    81
     ?<Initializer for AppTitle>      10
     ??Sys_Init?relay                  6
     ??Sys_ProcessEvent?relay          6
     ??Sys_ProcessZDOMsgs?relay        6
     ??Sys_MessageMSGCB?relay          6
     ??Sys_SendPreBindMessage?relay    6
     ??Sys_SendDataRequest?relay       6
     ??zb_StartConfirm?relay           6
     ??zb_FindDeviceConfirm?relay      6
     ??zb_HandleOsalEvent?relay        6
     ??Sys_SendCback?relay             6
     ??Sys_BindConfirm?relay           6
     ??Sys_SendDataConfirm?relay       6
     ??osalInitTasks?relay             6
     ?<Constant "bind">                6

 
 1 088 bytes in segment BANKED_CODE
    78 bytes in segment BANK_RELAYS
    10 bytes in segment XDATA_I
    10 bytes in segment XDATA_ID
    55 bytes in segment XDATA_ROM_C
    15 bytes in segment XDATA_Z
 
 1 176 bytes of CODE  memory
    55 bytes of CONST memory
    25 bytes of XDATA memory

Errors: none
Warnings: none
