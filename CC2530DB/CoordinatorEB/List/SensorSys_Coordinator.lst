###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.3.10338/W32 for 8051         15/Aug/2017  23:22:43 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\Source\SensorSys_Coordinator.c      #
#    Command line       =  -f D:\ProgramData\Hardware\zigbee\Projects\zstack\ #
#                          Samples\SensorSys\CC2530DB\..\..\..\Tools\CC2530DB #
#                          \f8wCoord.cfg (-DCPU32MHZ -DROOT=__near_func       #
#                          -DMAC_CFG_APP_PENDING_QUEUE=TRUE                   #
#                          -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8         #
#                          -DMAC_CFG_RX_MAX=5 -DZDO_COORDINATOR -DRTR_NWK)    #
#                          -f D:\ProgramData\Hardware\zigbee\Projects\zstack\ #
#                          Samples\SensorSys\CC2530DB\..\..\..\Tools\CC2530DB #
#                          \f8wConfig.cfg (-DZIGBEEPRO -DSECURE=0             #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFF1                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 D:\ProgramData\Hardware\zig #
#                          bee\Projects\zstack\Samples\SensorSys\Source\Senso #
#                          rSys_Coordinator.c -D ZTOOL_P1 -D MT_TASK -D       #
#                          MT_SYS_FUNC -D MT_ZDO_FUNC -D LCD_SUPPORTED=DEBUG  #
#                          -lC D:\ProgramData\Hardware\zigbee\Projects\zstack #
#                          \Samples\SensorSys\CC2530DB\CoordinatorEB\List\    #
#                          -lA D:\ProgramData\Hardware\zigbee\Projects\zstack #
#                          \Samples\SensorSys\CC2530DB\CoordinatorEB\List\    #
#                          --diag_suppress Pe001,Pa010 -o                     #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\CoordinatorEB\Obj\ -e      #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I D:\ProgramData\Hardware\zigbee\Projects\zstack\ #
#                          Samples\SensorSys\CC2530DB\ -I                     #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\Source\ -I              #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\ZMain\TI2530DB\   #
#                          -I D:\ProgramData\Hardware\zigbee\Projects\zstack\ #
#                          Samples\SensorSys\CC2530DB\..\..\..\..\..\Componen #
#                          ts\hal\include\ -I D:\ProgramData\Hardware\zigbee\ #
#                          Projects\zstack\Samples\SensorSys\CC2530DB\..\..\. #
#                          .\..\..\Components\hal\target\CC2530EB\ -I         #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          mac\include\ -I D:\ProgramData\Hardware\zigbee\Pro #
#                          jects\zstack\Samples\SensorSys\CC2530DB\..\..\..\. #
#                          .\..\Components\mac\high_level\ -I                 #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          mac\low_level\srf04\ -I D:\ProgramData\Hardware\zi #
#                          gbee\Projects\zstack\Samples\SensorSys\CC2530DB\.. #
#                          \..\..\..\..\Components\mac\low_level\srf04\single #
#                          _chip\ -I D:\ProgramData\Hardware\zigbee\Projects\ #
#                          zstack\Samples\SensorSys\CC2530DB\..\..\..\..\..\C #
#                          omponents\mt\ -I D:\ProgramData\Hardware\zigbee\Pr #
#                          ojects\zstack\Samples\SensorSys\CC2530DB\..\..\..\ #
#                          ..\..\Components\osal\include\ -I                  #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          services\saddr\ -I D:\ProgramData\Hardware\zigbee\ #
#                          Projects\zstack\Samples\SensorSys\CC2530DB\..\..\. #
#                          .\..\..\Components\services\sdata\ -I              #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\af\ -I D:\ProgramData\Hardware\zigbee\Projec #
#                          ts\zstack\Samples\SensorSys\CC2530DB\..\..\..\..\. #
#                          .\Components\stack\nwk\ -I                         #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\sapi\ -I D:\ProgramData\Hardware\zigbee\Proj #
#                          ects\zstack\Samples\SensorSys\CC2530DB\..\..\..\.. #
#                          \..\Components\stack\sec\ -I                       #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\sys\ -I D:\ProgramData\Hardware\zigbee\Proje #
#                          cts\zstack\Samples\SensorSys\CC2530DB\..\..\..\..\ #
#                          ..\Components\stack\zdo\ -I                        #
#                          D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\..\..\..\..\..\Components\ #
#                          zmac\ -I D:\ProgramData\Hardware\zigbee\Projects\z #
#                          stack\Samples\SensorSys\CC2530DB\..\..\..\..\..\Co #
#                          mponents\zmac\f8w\ -Ohz --require_prototypes       #
#    List file          =  D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\CoordinatorEB\List\SensorS #
#                          ys_Coordinator.lst                                 #
#    Object file        =  D:\ProgramData\Hardware\zigbee\Projects\zstack\Sam #
#                          ples\SensorSys\CC2530DB\CoordinatorEB\Obj\SensorSy #
#                          s_Coordinator.r51                                  #
#                                                                             #
#                                                                             #
###############################################################################

D:\ProgramData\Hardware\zigbee\Projects\zstack\Samples\SensorSys\Source\SensorSys_Coordinator.c
      1          /**************************************************************************************************
      2            Filename:       Sys.c
      3            Revised:        $Date: 2009-03-18 15:56:27 -0700 (Wed, 18 Mar 2009) $
      4            Revision:       $Revision: 19453 $
      5          
      6            Description:    Generic Application (no Profile).
      7          
      8          
      9            Copyright 2004-2009 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED AS IS?WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com. 
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41            This application isn't intended to do anything useful, it is
     42            intended to be a simple example of an application's structure.
     43          
     44            This application sends "Hello World" to another "Generic"
     45            application every 15 seconds.  The application will also
     46            receive "Hello World" packets.
     47          
     48            The "Hello World" messages are sent/received as MSG type message.
     49          
     50            This applications doesn't have a profile, so it handles everything
     51            directly - itself.
     52          
     53            Key control:
     54              SW1:
     55              SW2:  initiates end device binding
     56              SW3:
     57              SW4:  initiates a match description request
     58          *********************************************************************/
     59          
     60          /*********************************************************************
     61           * INCLUDES
     62           */
     63          #include "OSAL.h"
     64          #include "AF.h"
     65          #include "ZDApp.h"
     66          #include "ZDObject.h"
     67          #include "ZDProfile.h"
     68          
     69          #include "SensorSys.h"
     70          #include "DebugTrace.h"
     71          
     72          #if !defined( WIN32 )
     73            #include "OnBoard.h"
     74          #endif
     75          
     76          /* HAL */
     77          #include "hal_led.h"
     78          #include "hal_key.h"
     79          #include "hal_uart.h"
     80          
     81          /*********************************************************************
     82           * MACROS
     83           */
     84          
     85          /*********************************************************************
     86           * CONSTANTS
     87           */
     88          
     89          /*********************************************************************
     90           * TYPEDEFS
     91           */
     92          
     93          /*********************************************************************
     94           * GLOBAL VARIABLES
     95           */
     96          uint8 AppTitle[]="SensorAPP"; //应用程序名称
     97          
     98          // Sys 端点的簇ID
     99          // This list should be filled with Application specific Cluster IDs.
    100          const cId_t Sys_ClusterList[SYS_MAX_CLUSTERS] =
    101          {
    102            SYS_CLUSTERID
    103          };
    104          
    105          // Button 端点的簇ID
    106          // This list should be filled with Application specific Cluster IDs.
    107          const cId_t Button_ClusterList[BUTTON_MAX_CLUSTERS] =
    108          {
    109            BUTTON_CLUSTERID
    110          };
    111          
    112          // Sys 端点简单描述符
    113          const SimpleDescriptionFormat_t Sys_SimpleDesc =
    114          {
    115          	SYS_ENDPOINT,           //  int Endpoint;
    116          	SYS_PROFID,                //  uint16 AppProfId[2];
    117          	SYS_DEVICEID,              //  uint16 AppDeviceId[2];
    118          	SYS_DEVICE_VERSION,        //  int   AppDevVer:4;
    119          	SYS_FLAGS,                 //  int   AppFlags:4;
    120          	SYS_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    121          	(cId_t *)Sys_ClusterList,  //  byte *pAppInClusterList;
    122          	SYS_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    123          	(cId_t *)Sys_ClusterList   //  byte *pAppInClusterList;
    124          };
    125          
    126          // Button 端点简单描述符
    127          const SimpleDescriptionFormat_t Button_SimpleDesc =
    128          {
    129          	BUTTON_ENDPOINT,           //  int Endpoint;
    130          	SYS_PROFID,                //  uint16 AppProfId[2];
    131          	SYS_DEVICEID,              //  uint16 AppDeviceId[2];
    132          	SYS_DEVICE_VERSION,        //  int   AppDevVer:4;
    133          	SYS_FLAGS,                 //  int   AppFlags:4;
    134          	BUTTON_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    135          	(cId_t *)Button_ClusterList,  //  byte *pAppInClusterList;
    136          	BUTTON_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    137          	(cId_t *)Button_ClusterList   //  byte *pAppInClusterList;
    138          };
    139          
    140          
    141          // This is the Endpoint/Interface description.  It is defined here, but
    142          // filled-in in Button_Init().  Another way to go would be to fill
    143          // in the structure here and make it a "const" (in code space).  The
    144          // way it's defined in this sample app it is define in RAM.
    145          endPointDesc_t Sys_epDesc;
    146          endPointDesc_t Button_epDesc;
    147          
    148          /*********************************************************************
    149           * EXTERNAL VARIABLES
    150           */
    151          
    152          /*********************************************************************
    153           * EXTERNAL FUNCTIONS
    154           */
    155          
    156          /*********************************************************************
    157           * LOCAL VARIABLES
    158           */
    159          static uint8 myAppState = APP_INIT;
    160          
    161          byte Sys_TaskID;
    162          byte Button_TaskID;   // Task ID for internal task/event processing
    163                                  // This variable will be received when
    164                                  // Button_Init() is called.
    165          
    166          devStates_t Sys_NwkState;   // 节点现在的网络状态
    167          
    168          
    169          byte Sys_TransID;  // 数据包的发送ID，每发一个自增1
    170          
    171          afAddrType_t Broadcast_DstAddr;
    172          afAddrType_t Button_DstAddr;
    173          
    174          static uint8 sysSeqNumber = 0;    // 在端点间数据交流时被使用zb_SendDataRequest
    175          
    176          /*********************************************************************
    177           * LOCAL FUNCTIONS
    178           */
    179          void Sys_Init( byte task_id );
    180          void Button_Init( byte task_id );
    181          
    182          UINT16 Sys_ProcessEvent( byte task_id, UINT16 events );
    183          void Sys_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg, byte task_id );
    184          void Button_HandleKeys( byte shift, byte keys );
    185          void Sys_MessageMSGCB( afIncomingMSGPacket_t *pckt, byte task_id );
    186          void Sys_SendPreBindMessage( byte type_id );
    187          
    188          /*********************************************************************
    189           * NETWORK LAYER CALLBACKS
    190           */
    191          
    192          /*********************************************************************
    193           * PUBLIC FUNCTIONS
    194           */
    195          
    196          /*********************************************************************
    197           * @fn      Sys_Init
    198           *
    199           * @brief   Initialization function for the Generic App Task.
    200           *          This is called during initialization and should contain
    201           *          any application specific initialization (ie. hardware
    202           *          initialization/setup, table initialization, power up
    203           *          notificaiton ... ).
    204           *
    205           * @param   task_id - the ID assigned by OSAL.  This ID should be
    206           *                    used to send messages and set timers.
    207           *
    208           * @return  none
    209           */
    210          void Sys_Init( byte task_id )
    211          {
    212            Sys_TaskID = task_id;
    213          
    214            // Device hardware initialization can be added here or in main() (Zmain.c).
    215            // If the hardware is application specific - add it here.
    216            // If the hardware is other parts of the device add it in main().
    217          
    218            Broadcast_DstAddr.addrMode = (afAddrMode_t)AddrBroadcast;
    219            Broadcast_DstAddr.endPoint = SYS_ENDPOINT;
    220            Broadcast_DstAddr.addr.shortAddr = 0xFFFF;
    221          
    222            // Fill out the endpoint description.
    223            Sys_epDesc.endPoint = SYS_ENDPOINT;
    224            Sys_epDesc.task_id = &Sys_TaskID;
    225            Sys_epDesc.simpleDesc
    226                      = (SimpleDescriptionFormat_t *)&Sys_SimpleDesc;
    227            Sys_epDesc.latencyReq = noLatencyReqs;
    228          
    229            // Register the endpoint description with the AF
    230            afRegister( &Sys_epDesc );
    231          
    232            // To Update the display...
    233          }
    234          
    235          /*********************************************************************
    236           * @fn      Button_Init
    237           *
    238           * @brief   Initialization function for the Generic App Task.
    239           *          This is called during initialization and should contain
    240           *          any application specific initialization (ie. hardware
    241           *          initialization/setup, table initialization, power up
    242           *          notificaiton ... ).
    243           *
    244           * @param   task_id - the ID assigned by OSAL.  This ID should be
    245           *                    used to send messages and set timers.
    246           *
    247           * @return  none
    248           */
    249          void Button_Init( byte task_id )
    250          {
    251            Button_TaskID = task_id;
    252          
    253            // Device hardware initialization can be added here or in main() (Zmain.c).
    254            // If the hardware is application specific - add it here.
    255            // If the hardware is other parts of the device add it in main().
    256          
    257            Button_DstAddr.addrMode = (afAddrMode_t)AddrNotPresent;
    258            Button_DstAddr.endPoint = 0;
    259            Button_DstAddr.addr.shortAddr = 0;
    260          
    261            // Fill out the endpoint description.
    262            Button_epDesc.endPoint = BUTTON_ENDPOINT;
    263            Button_epDesc.task_id = &Button_TaskID;
    264            Button_epDesc.simpleDesc
    265                      = (SimpleDescriptionFormat_t *)&Button_SimpleDesc;
    266            Button_epDesc.latencyReq = noLatencyReqs;
    267          
    268            // Register the endpoint description with the AF
    269            afRegister( &Button_epDesc );
    270          
    271            // Register for all key events - This app will handle all key events
    272            RegisterForKeys( Button_TaskID );
    273          
    274            // To Update the display...
    275           
    276            ZDO_RegisterForZDOMsg( Button_TaskID, Match_Desc_rsp );
    277          }
    278          
    279          /*********************************************************************
    280           * @fn      Sys_ProcessEvent
    281           *
    282           * @brief   Generic Application Task event processor.  This function
    283           *          is called to process all events for the task.  Events
    284           *          include timers, messages and any other user defined events.
    285           *
    286           * @param   task_id  - The OSAL assigned task ID.
    287           * @param   events - events to process.  This is a bit map and can
    288           *                   contain more than one event.
    289           *
    290           * @return  none
    291           */
    292          UINT16 Sys_ProcessEvent( byte task_id, UINT16 events )
    293          {
    294            afIncomingMSGPacket_t *MSGpkt = NULL;
    295            afDataConfirm_t *afDataConfirm;
    296          
    297            // Data Confirmation message fields
    298            byte sentEP;
    299            ZStatus_t sentStatus;
    300            byte sentTransID;       // This should match the value sent
    301            (void)task_id;  // Intentionally unreferenced parameter
    302          
    303            if ( events & SYS_EVENT_MSG )
    304            {
    305              if(task_id == Sys_TaskID)
    306              {
    307                MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( task_id );
    308                while ( MSGpkt )
    309                {
    310                  switch ( MSGpkt->hdr.event )
    311                  {
    312                    case ZDO_CB_MSG:  // 收到被绑定节点的rsp
    313                      Sys_ProcessZDOMsgs( (zdoIncomingMsg_t *)MSGpkt, task_id );
    314                      break;
    315          
    316                    case AF_DATA_CONFIRM_CMD:
    317                      // This message is received as a confirmation of a data packet sent.
    318                      // The status is of ZStatus_t type [defined in ZComDef.h]
    319                      // The message fields are defined in AF.h
    320                      afDataConfirm = (afDataConfirm_t *)MSGpkt;
    321                      sentEP = afDataConfirm->endpoint;
    322                      sentStatus = afDataConfirm->hdr.status;
    323                      sentTransID = afDataConfirm->transID;
    324                      (void)sentEP;
    325                      (void)sentTransID;
    326          
    327                      // Action taken when confirmation is received.
    328                      if ( sentStatus != ZSuccess )
    329                      {
    330                        // The data wasn't delivered -- Do something
    331                      }
    332                      break;
    333          
    334                    case AF_INCOMING_MSG_CMD:
    335                      Sys_MessageMSGCB( MSGpkt, task_id );
    336                      break;
    337          
    338                    case ZDO_STATE_CHANGE:
    339                      Sys_NwkState = (devStates_t)(MSGpkt->hdr.status);
    340                      if ( (Sys_NwkState == DEV_ZB_COORD) )
    341                      {
    342                        ;
    343                      }
    344                      break;
    345          
    346                    default:
    347                      break;
    348                  }
    349          
    350                  // Release the memory
    351                  osal_msg_deallocate( (uint8 *)MSGpkt );
    352          
    353                  // Next
    354                  MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( Sys_TaskID );
    355                }
    356              }
    357          
    358              if(task_id == Button_TaskID)
    359              {
    360                MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( task_id );
    361                while ( MSGpkt )
    362                {
    363                  switch ( MSGpkt->hdr.event )
    364                  {
    365                      case KEY_CHANGE:
    366                         Button_HandleKeys( ((keyChange_t *)MSGpkt)->state, ((keyChange_t *)MSGpkt)->keys );
    367                      break;
    368                  }
    369                  // Release the memory
    370                  osal_msg_deallocate( (uint8 *)MSGpkt );
    371          
    372                  // Next
    373                  MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( Button_TaskID );
    374                }
    375              }
    376          
    377              // return unprocessed events
    378              return (events ^ SYS_EVENT_MSG);
    379            }
    380          
    381             if( events & MATCH_BIND_EVT ) // 广播 match 绑定
    382             {
    383                if(task_id == Button_TaskID)
    384                {
    385                   zb_BindDevice(TRUE, BUTTON_CMD_ID, NULL);
                          ^
Error[Pe223]: function "zb_BindDevice" declared implicitly
    386                   HalLedSet(HAL_LED_2, HAL_LED_MODE_ON); // 亮绿灯
    387                }
    388                return (events ^ MATCH_BIND_EVT);
    389             }
    390          
    391          
    392            // Discard unknown events
    393            return 0;
    394          }
    395          
    396          /*********************************************************************
    397           * Event Generation Functions
    398           */
    399          
    400          /*********************************************************************
    401           * @fn      Sys_ProcessZDOMsgs()
    402           *
    403           * @brief   Process response messages
    404           *
    405           * @param   none
    406           *
    407           * @return  none
    408           */
    409          void Sys_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg , byte task_id )
    410          {
    411            switch ( inMsg->clusterID )
    412            {
    413              case End_Device_Bind_rsp:
    414                if ( ZDO_ParseBindRsp( inMsg ) == ZSuccess )
    415                {
    416                  // Light LED
    417                  HalLedSet( HAL_LED_4, HAL_LED_MODE_ON );
    418                }
    419          #if defined(BLINK_LEDS)
    420                else
    421                {
    422                  // Flash LED to show failure
    423                  HalLedSet ( HAL_LED_4, HAL_LED_MODE_FLASH );
    424                }
    425          #endif
    426                break;
    427          
    428              case Match_Desc_rsp:
    429                {
    430                  ZDO_ActiveEndpointRsp_t *pRsp = ZDO_ParseEPListRsp( inMsg );
    431                  if ( pRsp )
    432                  {
    433                    if ( pRsp->status == ZSuccess && pRsp->cnt )
    434                    {
    435                      switch (task_id)
    436                      {
    437                        case Button_TaskID:
                                    ^
Error[Pe028]: expression must have a constant value
    438                        {
    439                          Button_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;
    440                          Button_DstAddr.addr.shortAddr = pRsp->nwkAddr;
    441                          // Take the first endpoint, Can be changed to search through endpoints
    442                          Button_DstAddr.endPoint = pRsp->epList[0];
    443          
    444                          HalLedSet( HAL_LED_4, HAL_LED_MODE_ON );
    445                        }
    446          
    447                        // case Led_TaskID:
    448                      }
    449                    }
    450                    osal_mem_free( pRsp );
    451                  }
    452                }
    453                break;
    454            }
    455          }
    456          
    457          /*********************************************************************
    458           * @fn      Button_HandleKeys
    459           *
    460           * @brief   Handles all key events for this device.
    461           *
    462           * @param   shift - true if in shift/alt.
    463           * @param   keys - bit field for key events. Valid entries:
    464           *                 HAL_KEY_SW_4
    465           *                 HAL_KEY_SW_3
    466           *                 HAL_KEY_SW_2
    467           *                 HAL_KEY_SW_1
    468           *
    469           * @return  none
    470           */
    471          void Button_HandleKeys( byte shift, byte keys )
    472          {
    473            zAddrType_t dstAddr;
    474            
    475            // Shift is used to make each button/switch dual purpose.
    476            if ( shift )
    477            {
    478              if ( keys & HAL_KEY_SW_1 )
    479              {
    480              }
    481              if ( keys & HAL_KEY_SW_2 )
    482              {
    483              }
    484              if ( keys & HAL_KEY_SW_3 )
    485              {
    486              }
    487              if ( keys & HAL_KEY_SW_4 )
    488              {
    489              }
    490            }
    491            else
    492            {
    493              if ( keys & HAL_KEY_SW_1 )
    494              {
    495                Sys_SendPreBindMessage(BUTTON_TYPE_ID);
    496              }
    497          
    498              // 对远程端点发送命令
    499              if ( keys & HAL_KEY_SW_2 )
    500              {
    501                //( uint16 destination, uint16 commandId, uint8 len,
    502                //  uint8 *pData, uint8 handle, uint8 txOptions, uint8 radius )
    503                zb_SendDataRequest( 0xFFFE,  BUTTON_CMD_ID, 0,
                       ^
Error[Pe223]: function "zb_SendDataRequest" declared implicitly

    zAddrType_t dstAddr;
                ^
"D:\ProgramData\Hardware\zigbee\Projects\zstack\Samples\SensorSys\Source\SensorSys_Coordinator.c",473  Warning[Pe177]: 
          variable "dstAddr" was declared but never referenced
    504                                  (uint8 *)NULL, sysSeqNumber, 0, 0 );
    505                // 0xFFFE -- 没有目的地址的dstaddr(Match 的 addr)
    506              }
    507          
    508              if ( keys & HAL_KEY_SW_3 )
    509              {
    510              }
    511          
    512              // 是用来查找有没有东西可以匹配的
    513              if ( keys & HAL_KEY_SW_4 )
    514              {/*
    515                HalLedSet ( HAL_LED_4, HAL_LED_MODE_OFF );
    516                // Initiate a Match Description Request (Service Discovery)
    517                dstAddr.addrMode = AddrBroadcast;
    518                dstAddr.addr.shortAddr = NWK_BROADCAST_SHORTADDR;
    519                ZDP_MatchDescReq( &dstAddr, NWK_BROADCAST_SHORTADDR,
    520                                  SYS_PROFID,
    521                                  SYS_MAX_CLUSTERS, (cId_t *)Button_ClusterList,
    522                                  SYS_MAX_CLUSTERS, (cId_t *)Button_ClusterList,
    523                                  FALSE );
    524                                  */
    525              }
    526            }
    527          }
    528          
    529          /*********************************************************************
    530           * LOCAL FUNCTIONS
    531           */
    532          
    533          /*********************************************************************
    534           * @fn      Sys_MessageMSGCB
    535           *
    536           * @brief   Data message processor callback.  This function processes
    537           *          any incoming data - probably from other devices.  So, based
    538           *          on cluster ID, perform the intended action.
    539           *
    540           * @param   none
    541           *
    542           * @return  none
    543           */
    544          void Sys_MessageMSGCB( afIncomingMSGPacket_t *pkt, byte task_id )
    545          {
    546            switch ( pkt->clusterId )
    547            {
    548              case BUTTON_CLUSTERID:
    549                // "the" message
    550          #if defined( WIN32 )
    551                WPRINTSTR( pkt->cmd.Data );
    552          #endif
    553                break;
    554            }
    555          }
    556          
    557          /*********************************************************************
    558           * @fn      Sys_SendPreBindMessage
    559           * * @brief   Broadcast prebind message.
    560           *
    561           *
    562           * @param   type_id : 想要绑定的终端类型
    563           *
    564           * @return  none
    565           */
    566          void Sys_SendPreBindMessage( byte type_id )
    567          {
    568            char theMessageData[5] = "bind";
    569            theMessageData[4] = type_id;
    570          
    571            if ( AF_DataRequest( &Boardcast_DstAddr, &Sys_epDesc,
                                         ^
Error[Pe020]: identifier "Boardcast_DstAddr" is undefined

  static uint8 myAppState = APP_INIT;
               ^
"D:\ProgramData\Hardware\zigbee\Projects\zstack\Samples\SensorSys\Source\SensorSys_Coordinator.c",159  Warning[Pe177]: 
          variable "myAppState" was declared but never referenced
    572                                 SYS_CLUSTERID,
    573                                 (byte)osal_strlen( theMessageData ) + 1,
    574                                 (byte *)&theMessageData,
    575                                 &Sys_TransID,
    576                                 AF_DISCV_ROUTE, AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    577            {
    578              // Successfully requested to be sent.
    579             //if(想要绑定什么就对应的 TypeID)
    580             if(type_id == BUTTON_TYPE_ID)
    581                osal_start_timerEx(Button_TaskID, MATCH_BIND_EVT, 5000);
    582          
    583            }
    584            else
    585            {
    586              // Error occurred in request to send.
    587            }
    588          }
    589          
    590          /*********************************************************************
    591          *********************************************************************/

Errors: 4
Warnings: 2
